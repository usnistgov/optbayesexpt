
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>optbayesexpt.particlepdf &#8212; OptBayesExpt 1.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <link rel="stylesheet" href="https://pages.nist.gov/nist-header-footer/css/nist-combined.css" type="text/css" />
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" type="text/javascript"></script>
    <script src="https://pages.nist.gov/nist-header-footer/js/nist-header-footer.js" type="text/javascript" defer="defer"></script>

<script type="text/javascript" src="https://pages.nist.gov/leaveNotice/js/jquery.leaveNotice-nist.min.js"></script>
<script>
$(document).ready(function(){
  // Mark external (non-nist.gov) A tags with class "external"
  //If the adress start with https and ends with nist.gov
  var re_nist = new RegExp('^https?:\/\/((^\/)*\.)*nist\\.gov(\/|$)');
  //Regex to find address that start with https
  var re_absolute_address = new RegExp('^((https?:)?\/\/)');
  $("a").each(function(){
    var url=$(this).attr('href');
    if(re_nist.test(url) || !re_absolute_address.test(url)){
      $(this).addClass('local');
    }else{
      //This a href appears to be external, so tag it
      $(this).addClass('external');
    }
  });
  // Add leaveNotice to external A elements
  $('a.external').leaveNotice();
});
</script>
<link rel="stylesheet" type="text/css" href="https://pages.nist.gov/leaveNotice/css/jquery.leaveNotice.css" />

<script async type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=NIST&subagency=github&pua=UA-42404149-54&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c">
</script>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OptBayesExpt 1.2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">optbayesexpt.particlepdf</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for optbayesexpt.particlepdf</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">GOT_NUMBA</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">float64</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">GOT_NUMBA</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="ParticlePDF"><a class="viewcode-back" href="../../particlepdf.html#optbayesexpt.particlepdf.ParticlePDF">[docs]</a><span class="k">class</span> <span class="nc">ParticlePDF</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A probability distribution function.</span>

<span class="sd">    A probability distribution :math:`P(\\theta_0, \\theta_1, \\ldots,</span>
<span class="sd">    \\theta_{n\_dims})` over parameter variables :math:`\\theta_i` is</span>
<span class="sd">    represented by a large-ish number of samples from the distribution,</span>
<span class="sd">    each with a weight value.  The distribution can be visualized as a cloud</span>
<span class="sd">    of particles in parameter space, with each particle corresponding to a</span>
<span class="sd">    weighted random draw from the distribution.  The methods implemented</span>
<span class="sd">    here largely follow the algorithms published in Christopher E Granade et</span>
<span class="sd">    al. 2012 *New J. Phys.* **14** 103013.</span>

<span class="sd">    Warnings:</span>

<span class="sd">        The number of samples (i.e. particles) required for good performance</span>
<span class="sd">        will depend on the application.  Too many samples will slow down the</span>
<span class="sd">        calculations, but too few samples can produce incorrect results.</span>
<span class="sd">        With too few samples, the probability distribution can become overly</span>
<span class="sd">        narrow, and it may not include the &quot;true&quot; parameter values. See the</span>
<span class="sd">        ``resample()`` method documentation for details.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        prior (:obj:`2D array-like`):</span>
<span class="sd">            The Bayesian *prior*, which initializes the :obj:`ParticlePDF`</span>
<span class="sd">            distribution. Each of ``n_dims`` sub-arrays contains</span>
<span class="sd">            ``n_particles`` values of a single parameter, so that the *j*\</span>
<span class="sd">            _th elements of the sub-arrays determine the coordinates of a</span>
<span class="sd">            point in parameter space. Users are encouraged to experiment with</span>
<span class="sd">            different ``n_particles`` sizes to assure consistent results.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        a_param: (float) In resampling, determines the scale of random</span>
<span class="sd">            diffusion relative to the distribution covariance.  After</span>
<span class="sd">            weighted sampling, some parameter values may have been</span>
<span class="sd">            chosen multiple times. To make the new distribution smoother,</span>
<span class="sd">            the parameters are given small &#39;nudges&#39;, random displacements</span>
<span class="sd">            much smaller than the overall parameter distribution, but with</span>
<span class="sd">            the same shape as the overall distribution.  More precisely,</span>
<span class="sd">            the covariance of the nudge distribution is :code:`(1 -</span>
<span class="sd">            a_param ** 2)` times the covariance of the parameter distribution.</span>
<span class="sd">            Default ``0.98``.</span>

<span class="sd">        scale (:obj:`bool`): determines whether resampling includes a</span>
<span class="sd">            contraction of the parameter distribution toward the</span>
<span class="sd">            distribution mean.  The idea of this contraction is to</span>
<span class="sd">            compensate for the overall expansion of the distribution</span>
<span class="sd">            that is a by-product of random displacements.  If true,</span>
<span class="sd">            parameter samples (particles) move a fraction ``a_param`` of</span>
<span class="sd">            the distance to the distribution mean.  Default is ``True``,</span>
<span class="sd">            but ``False`` is recommended.</span>

<span class="sd">        resample_threshold (:obj:`float`): Sets a threshold for automatic</span>
<span class="sd">            resampling. Resampling is triggered when the effective fraction of</span>
<span class="sd">            particles, :math:`1 / (N\\sum_i^N w_i^2)`, is smaller than</span>
<span class="sd">            ``resample_threshold``.  Default ``0.5``.</span>

<span class="sd">        auto_resample (:obj:`bool`): Determines whether threshold testing and</span>
<span class="sd">            resampling are performed when ``bayesian_update()`` is called.</span>
<span class="sd">            Default ``True``.</span>

<span class="sd">        use_jit (:obj:`bool`): Allows precompilation of some methods for a</span>
<span class="sd">            modest increase in speed.  Only effective on systems where</span>
<span class="sd">            ``numba`` is installed. Default ``True``</span>

<span class="sd">    **Attributes:**</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prior</span><span class="p">,</span> <span class="n">a_param</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">resample_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                 <span class="n">auto_resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_jit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="c1">#: dict: A package of parameters affecting the resampling algorithm</span>
        <span class="c1">#:</span>
        <span class="c1">#:     - ``&#39;a_param&#39;`` (:obj:`float`): Initially, the value of the</span>
        <span class="c1">#:       ``a_param`` keyword argument.  Default ``0.98``</span>
        <span class="c1">#:</span>
        <span class="c1">#:     - ``&#39;scale&#39;`` (:obj:`bool`): Initially, the value of the</span>
        <span class="c1">#:       ``scale`` keyword argument. Default ``True``</span>
        <span class="c1">#:</span>
        <span class="c1">#:     - ``&#39;resample_threshold&#39;`` (:obj:`float`):  Initially,</span>
        <span class="c1">#:       the value of the ``resample_threshold`` keyword argument.</span>
        <span class="c1">#:       Default ``0.5``.</span>
        <span class="c1">#:</span>
        <span class="c1">#:     - ``&#39;auto_resample&#39;`` (:obj:`bool`): Initially, the value of the</span>
        <span class="c1">#:       ``auto_resample`` keyword argument. Default ``True``.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuning_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a_param&#39;</span><span class="p">:</span> <span class="n">a_param</span><span class="p">,</span>
                                  <span class="s1">&#39;resample_threshold&#39;</span><span class="p">:</span> <span class="n">resample_threshold</span><span class="p">,</span>
                                  <span class="s1">&#39;auto_resample&#39;</span><span class="p">:</span> <span class="n">auto_resample</span><span class="p">,</span>
                                  <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="p">}</span>

        <span class="c1">#: ``n_dims x n_particles ndarray`` of ``float64``: Together with</span>
        <span class="c1">#: ``particle_weights``,#: these ``n_particles`` points represent</span>
        <span class="c1">#: the parameter probability distribution. Initialized by the</span>
        <span class="c1">#: ``prior`` argument.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">prior</span><span class="p">)</span>

        <span class="c1">#: ``int``: the number of parameter samples representing the</span>
        <span class="c1">#: probability distribution. Determined from the trailing dimension</span>
        <span class="c1">#: of ``prior``.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#: ``int``: The number of parameters, i.e. the dimensionality of</span>
        <span class="c1">#: parameter space. Determined from the leading dimension of ``prior``.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#: ``ndarray`` of ``int``: Indices into the particle arrays.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_particle_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="c1">#: ndarray of ``float64``: Array of probability weights</span>
        <span class="c1">#: corresponding to the particles.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span>

        <span class="c1">#: ``bool``: A flag set by the ``resample_test()`` function. ``True`` if</span>
        <span class="c1">#: the last ``bayesian_update()`` resulted in resampling,</span>
        <span class="c1">#: else ``False``.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">just_resampled</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Precompile numerically intensive functions for speed</span>
        <span class="c1"># and overwrite _normalized_product() method.</span>
        <span class="k">if</span> <span class="n">GOT_NUMBA</span> <span class="ow">and</span> <span class="n">use_jit</span><span class="p">:</span>
            <span class="nd">@njit</span><span class="p">([</span><span class="n">float64</span><span class="p">[:](</span><span class="n">float64</span><span class="p">[:],</span> <span class="n">float64</span><span class="p">[:])],</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">_proto_normalized_product</span><span class="p">(</span><span class="n">wgts</span><span class="p">,</span> <span class="n">lkl</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">wgts</span> <span class="o">*</span> <span class="n">lkl</span>
                <span class="k">return</span> <span class="n">tmp</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">_proto_normalized_product</span><span class="p">(</span><span class="n">wgts</span><span class="p">,</span> <span class="n">lkl</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">wgts</span> <span class="o">*</span> <span class="n">lkl</span>
                <span class="k">return</span> <span class="n">tmp</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalized_product</span> <span class="o">=</span> <span class="n">_proto_normalized_product</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span>

<div class="viewcode-block" id="ParticlePDF.set_pdf"><a class="viewcode-back" href="../../particlepdf.html#optbayesexpt.particlepdf.ParticlePDF.set_pdf">[docs]</a>    <span class="k">def</span> <span class="nf">set_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Re-initializes the probability distribution</span>

<span class="sd">        Also resets ``n_particles`` and ``n_dims`` deduced from the</span>
<span class="sd">        dimensions of ``samples``.</span>

<span class="sd">        Args:</span>
<span class="sd">            samples (array-like):  A representation of the new distribution</span>
<span class="sd">                comprising `n_dims` sub-arrays of `n_particles`</span>
<span class="sd">                samples of each parameter.</span>
<span class="sd">            weights (ndarray): If ``None``, weights will be assigned uniform</span>
<span class="sd">                probability.  Otherwise, an array of length ``n_particles``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span>\
                                    <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Length of weights does not match the &#39;</span>
                                 <span class="s1">&#39;number of particles.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParticlePDF.mean"><a class="viewcode-back" href="../../particlepdf.html#optbayesexpt.particlepdf.ParticlePDF.mean">[docs]</a>    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the mean of the probability distribution.</span>

<span class="sd">        The weighted mean of the parameter distribution. See also</span>
<span class="sd">        :obj:`std()` and :obj:`covariance()`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Size ``n_dims`` array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParticlePDF.covariance"><a class="viewcode-back" href="../../particlepdf.html#optbayesexpt.particlepdf.ParticlePDF.covariance">[docs]</a>    <span class="k">def</span> <span class="nf">covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the covariance of the probability distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The covariance of the parameter distribution as an</span>
<span class="sd">            ``n_dims`` X ``n_dims`` array. See also :obj:`mean()` and</span>
<span class="sd">            :obj:`std()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">raw_covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">aweights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">raw_covariance</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">raw_covariance</span></div>

<div class="viewcode-block" id="ParticlePDF.std"><a class="viewcode-back" href="../../particlepdf.html#optbayesexpt.particlepdf.ParticlePDF.std">[docs]</a>    <span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the standard deviation of the distribution.</span>

<span class="sd">        Calculates the square root of the diagonal elements of the</span>
<span class="sd">        covariance matrix.  See also :obj:`covariance()` and :obj:`mean()`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The standard deviation as an n_dims array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_dims</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">):</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span><span class="p">)</span>
            <span class="n">msq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span><span class="p">)</span>
            <span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">msq</span> <span class="o">-</span> <span class="n">mean</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParticlePDF.bayesian_update"><a class="viewcode-back" href="../../particlepdf.html#optbayesexpt.particlepdf.ParticlePDF.bayesian_update">[docs]</a>    <span class="k">def</span> <span class="nf">bayesian_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs a Bayesian update on the probability distribution.</span>

<span class="sd">        Multiplies ``particle_weights`` by the ``likelihood`` and</span>
<span class="sd">        renormalizes the probability</span>
<span class="sd">        distribution.  After the update, the distribution is tested for</span>
<span class="sd">        resampling depending on</span>
<span class="sd">        ``self.tuning_parameters[&#39;auto_resample&#39;]``.</span>

<span class="sd">        Args:</span>
<span class="sd">            likelihood: (:obj:`ndarray`):  An ``n_samples`` sized array</span>
<span class="sd">                describing the Bayesian likelihood of a measurement result</span>
<span class="sd">                calculated for each parameter combination.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalized_product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span><span class="p">,</span>
                                              <span class="n">likelihood</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuning_parameters</span><span class="p">[</span><span class="s1">&#39;auto_resample&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resample_test</span><span class="p">()</span></div>

<div class="viewcode-block" id="ParticlePDF.resample_test"><a class="viewcode-back" href="../../particlepdf.html#optbayesexpt.particlepdf.ParticlePDF.resample_test">[docs]</a>    <span class="k">def</span> <span class="nf">resample_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the distribution and performs a resampling if required.</span>

<span class="sd">        If the effective number of particles falls below</span>
<span class="sd">        ``self.tuning_parameters[&#39;resample_threshold&#39;] * n_particles``,</span>
<span class="sd">        performs a resampling.  Sets the ``just_resampled`` flag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_eff</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_eff</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">&lt;</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">tuning_parameters</span><span class="p">[</span><span class="s1">&#39;resample_threshold&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resample</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">just_resampled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">just_resampled</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ParticlePDF.resample"><a class="viewcode-back" href="../../particlepdf.html#optbayesexpt.particlepdf.ParticlePDF.resample">[docs]</a>    <span class="k">def</span> <span class="nf">resample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs a resampling of the distribution.</span>

<span class="sd">        Resampling refreshes the random draws that represent the probability</span>
<span class="sd">        distribution.  As Bayesian updates are made, the weights of</span>
<span class="sd">        low-probability particles can become very small.  These particles</span>
<span class="sd">        consume memory and computation time, and they contribute little to</span>
<span class="sd">        values that are determined from the distribution.  Resampling</span>
<span class="sd">        abandons some low-probability particles while allowing</span>
<span class="sd">        high-probability particles to multiply in higher-probability regions.</span>

<span class="sd">        *Sample impoverishment* can occur if there are too few particles. In</span>
<span class="sd">        this phenomenon, a resampling step fails to sample particles from an</span>
<span class="sd">        important, but low-probability region, effectively removing that</span>
<span class="sd">        region from future consideration. The symptoms of this ``sample</span>
<span class="sd">        impoverishment`` phenomenon include:</span>

<span class="sd">            - Inconsistent results from repeated runs.  Standard deviations</span>
<span class="sd">              from individual final distributions will be too small to</span>
<span class="sd">              explain the spread of individual mean values.</span>

<span class="sd">            - Sudden changes in the standard deviations or other measures of</span>
<span class="sd">              the distribution on resampling. The resampling is not</span>
<span class="sd">              *supposed* to change the distribution, just refresh its</span>
<span class="sd">              representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">randdraw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span>
        <span class="c1"># coords is n_dims x n_particles</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_dims</span><span class="p">)</span>

        <span class="n">covar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="p">()</span>
        <span class="n">old_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_dims</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># a_param is typically close to but less than 1</span>
        <span class="n">a_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuning_parameters</span><span class="p">[</span><span class="s1">&#39;a_param&#39;</span><span class="p">]</span>
        <span class="c1"># newcover is a small version of covar that determines the size of</span>
        <span class="c1"># the nudge.</span>
        <span class="n">newcovar</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a_param</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">covar</span>

        <span class="c1"># multivariate normal returns n_particles x n_dims array. &quot;.T&quot;</span>
        <span class="c1"># transposes to match coords shape.</span>
        <span class="n">nudged</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">newcovar</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuning_parameters</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]:</span>
            <span class="n">scaled</span> <span class="o">=</span> <span class="n">nudged</span> <span class="o">*</span> <span class="n">a_param</span> <span class="o">+</span> <span class="n">old_center</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a_param</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">scaled</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">nudged</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span><span class="p">,</span>
                                         <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParticlePDF.randdraw"><a class="viewcode-back" href="../../particlepdf.html#optbayesexpt.particlepdf.ParticlePDF.randdraw">[docs]</a>    <span class="k">def</span> <span class="nf">randdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_draws</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provides random parameter draws from the distribution</span>

<span class="sd">        Particles are selected randomly with probabilities given by</span>
<span class="sd">        ``self.particle_weights``.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_draws (:obj:`int`): the number of draws requested.  Default</span>
<span class="sd">              ``1``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An ``n_dims`` x ``N_DRAWS`` :obj:`ndarray` of parameter draws.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># draws = self.rng.choice(self.particles, size=n_draws,</span>
        <span class="c1"># p=self.particle_weights, axis=1)</span>
        <span class="n">draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_dims</span><span class="p">,</span> <span class="n">n_draws</span><span class="p">))</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_particle_indices</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_draws</span><span class="p">,</span>
                                  <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_weights</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">):</span>
            <span class="c1"># for j, selected_index in enumerate(indices):</span>
            <span class="c1">#     draws[i,j] = param[selected_index]</span>
            <span class="n">draws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">draws</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_normalized_product</span><span class="p">(</span><span class="n">weight_array</span><span class="p">,</span> <span class="n">likelihood_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;multiplies two arrays and normalizes the result.</span>

<span class="sd">        Functionality is added by overwriting in __init__().</span>
<span class="sd">        Precompiled by numba if available and if `use_jit = True`.</span>

<span class="sd">        Args:</span>
<span class="sd">            weight_array (``ndarray``): typically particle weights</span>
<span class="sd">            likelihood_array(``ndarray``: typically likelihoods</span>

<span class="sd">        Returns: a probability ``np.array`` with sum = 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<span class="c1"># end ParticlePDF definition</span>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OptBayesExpt 1.2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">optbayesexpt.particlepdf</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright National Institute of Standards and Technology.Not subject to copyright in the United States..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>